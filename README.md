# Lightweight Fault Isolation

Lightweight Fault Isolation (LFI) is a performant and secure software
sandboxing system targeting the ARM64 architecture. LFI allows you to run up to
32K sandboxes in a single address space while guaranteeing that the sandboxes
are completely isolated from each other. Each sandbox may be given up to 4GB of
memory.

The LFI sandboxer only accepts ELF binaries that pass a verification step to
ensure they are safe to run. These binaries may be generated by any
LFI-compatible compiler toolchain.

We provide a compiler pass that reads arbitrary GNU assembly files (`.s`), and
produces assembly files that will pass verification. Currently, we also provide
wrapper tools to transparently use the assembly rewriter with any version of
Clang, as well as prebuilt LFI-compatible libraries for an LLVM-based C/C++
toolchain (`compiler-rt`, `musl-libc`, `libc++`, `libc++abi`, `libunwind`).

LFI-compatible programs are performant: on the SPEC 2017 benchmark suite, we
observe a runtime overhead of 7% and a code size overhead of 14%. This compares
well with LLVM-based ahead-of-time WebAssembly compilers, which incur upwards
of 20% runtime overhead (measured on an M1 Mac and a GCP T2A instance). LFI is
also secure: the compiler toolchain used to produce LFI-compatible programs is
not a part of the trusted code base, and speculative sandbox breakout attacks
are mitigated by default (the sandbox does not rely on any branching bounds
checks or strong CFI).

LFI supports all source-level language features and targets the ARMv8.0-A ISA
(including SIMD), but does not support dynamic code generation. We are also
planning to add support for ARMv8.1+ extensions.

LFI is currently in development. For now, please only use it for
experimentation. In particular, so far the runtime has just been used for
collecting measurements, and does not provide a fully sandboxed environment. We
are currently working on rewriting it to be fully secure. A paper with
additional details will be publicly available in the next few months, so stay
tuned for that.

# Tools

The LFI project provides the following tools:

* `lfi-gen`: reads a `.s` file, and produces an LFI-compatible `.s` file.
* `lfi-verify`: verifies ELF binaries for LFI-compatibility.
* `lfi-run`: runs an LFI-compatible binary.
* `lfi-compile`: when invoked with a recognized compiler, this program will
  automatically interpose on the compilation process and invoke `lfi-gen` on
  the intermediate `.s` file. Currently only supports
  `clang`/`clang++`/`gcc`/`g++`.
* `scripts`: a collection of wrapper scripts that invoke `lfi-compile` with a
  desired compiler and set of compiler flags.

# Installation

First, install your system's version of Clang, LLVM, and LLD.

Next, build and install `lfi-gen` and `lfi-compile`, and download the LFI
LLVM-based toolchain from the releases page (alternatively, you may build it
yourself in `toolchain` by running `./install-toolchain /tmp/lfi-toolchain`).

Finally, build and install `lfi-run` by running `knit` in `lfi-run/` and move
it into your installation path of choice. You may also want to build and
install `lfi-verify` to use the verifier.

# Roadmap

The LFI project is currently under development. We are currently focused on the
following features:

* New capabilities and full security for the runtime.
* Support for additional ARM extensions.
* Support for cool new features that are not yet announced.
* Support for dynamic code generation.
* Support for ARM software context IDs for mitigating Spectre attacks (requires
  modifications to Linux, which Arm will hopefully implement soon).

In the future, we may explore support for additional architectures such as
x86-64 and RISC-V, but there is currently no plan to do so.
